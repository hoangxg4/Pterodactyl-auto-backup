name: Panel Auto Backup

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch: {}

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      PANEL_URL: ${{ secrets.PANEL_URL }}
      API_KEY: ${{ secrets.PANEL_API_KEY }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      MAX_BACKUPS: ${{ secrets.MAX_BACKUPS }}

    steps:
      - name: Run backup via curl
        run: |
          set -euo pipefail

          # --- KI·ªÇM TRA M√îI TR∆Ø·ªúNG ---
          if [ -z "${PANEL_URL:-}" ] || [ -z "${API_KEY:-}" ] || [ -z "${TELEGRAM_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "‚ùå Thi·∫øu env: PANEL_URL / API_KEY / TELEGRAM_TOKEN / TELEGRAM_CHAT_ID"
            exit 1
          fi

          if [ -z "${MAX_BACKUPS:-}" ]; then MAX_BACKUPS=10; fi

          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null

          # --- H√ÄM G·ª¨I TELEGRAM ---
          send_telegram() {
            local text="$1"
            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${text}" \
              -d "parse_mode=HTML" >/dev/null || true
          }

          api_request() {
            local method="$1"
            local url="$2"
            shift 2 || true
            curl -sS -X "$method" "$url" \
              -H "Authorization: Bearer ${API_KEY}" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -H "User-Agent: DBH" \
              "$@"
          }

          PANEL_URL="${PANEL_URL%/}"

          # --- B·∫ÆT ƒê·∫¶U X·ª¨ L√ù ---
          echo "üîç L·∫•y danh s√°ch server..."
          servers_json=$(api_request GET "${PANEL_URL}/api/client") || exit 1

          # KH·ªûI T·∫†O BI·∫æN T·ªîNG H·ª¢P
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          MESSAGE_DETAILS=""

          for row in $(echo "$servers_json" | jq -r '.data[] | @base64'); do
            _jq() { echo "$row" | base64 --decode | jq -r "$1"; }

            server_id=$(_jq '.attributes.identifier')
            server_name=$(_jq '.attributes.name')
            
            # Bi·∫øn t·∫°m ƒë·ªÉ l∆∞u th√¥ng tin c·ªßa ri√™ng server n√†y
            server_log=""

            echo "‚ñ∂ X·ª≠ l√Ω server: ${server_name}"

            # 1. L·∫•y danh s√°ch backup
            backups_json=$(api_request GET "${PANEL_URL}/api/client/servers/${server_id}/backups") || {
              FAIL_COUNT=$((FAIL_COUNT+1))
              MESSAGE_DETAILS="${MESSAGE_DETAILS}‚ùå <b>${server_name}</b>: L·ªói l·∫•y danh s√°ch backup"$'\n'
              continue
            }

            # 2. X√≥a backup c≈© n·∫øu ƒë·∫ßy
            backup_count=$(echo "$backups_json" | jq '.data | length')
            if [ "$backup_count" -ge "$MAX_BACKUPS" ]; then
              oldest=$(echo "$backups_json" | jq -r '.data | sort_by(.attributes.created_at) | .[0]')
              oldest_uuid=$(echo "$oldest" | jq -r '.attributes.uuid')
              oldest_name=$(echo "$oldest" | jq -r '.attributes.name')

              api_request DELETE "${PANEL_URL}/api/client/servers/${server_id}/backups/${oldest_uuid}" >/dev/null && \
              server_log="${server_log}üóëÔ∏è ƒê√£ x√≥a: ${oldest_name}"$'\n'
            fi

            # 3. T·∫°o backup m·ªõi
            backup_name="Auto Backup $(date '+%H-%M_%d-%m-%Y')"
            body=$(jq -n --arg name "$backup_name" '{name: $name}')

            new_backup=$(api_request POST "${PANEL_URL}/api/client/servers/${server_id}/backups" --data "$body") 
            
            if [ $? -eq 0 ]; then
              created_name=$(echo "$new_backup" | jq -r '.attributes.name')
              SUCCESS_COUNT=$((SUCCESS_COUNT+1))
              # G·ªôp log x√≥a (n·∫øu c√≥) v√† log t·∫°o th√†nh c√¥ng
              MESSAGE_DETAILS="${MESSAGE_DETAILS}‚úÖ <b>${server_name}</b>"$'\n'"${server_log}üì¶ T√™n: ${created_name}"$'\n\n'
            else
              FAIL_COUNT=$((FAIL_COUNT+1))
              MESSAGE_DETAILS="${MESSAGE_DETAILS}‚ùå <b>${server_name}</b>: Backup th·∫•t b·∫°i"$'\n\n'
            fi
          done

          # --- G·ª¨I TIN NH·∫ÆN T·ªîNG H·ª¢P ---
          # T·∫°o header th·ªëng k√™
          TOTAL_MSG="üìä <b>B√ÅO C√ÅO AUTO BACKUP</b>"$'\n'
          TOTAL_MSG="${TOTAL_MSG}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"$'\n'
          TOTAL_MSG="${TOTAL_MSG}‚úÖ Th√†nh c√¥ng: <b>${SUCCESS_COUNT}</b>"$'\n'
          TOTAL_MSG="${TOTAL_MSG}‚ùå Th·∫•t b·∫°i: <b>${FAIL_COUNT}</b>"$'\n'
          TOTAL_MSG="${TOTAL_MSG}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"$'\n\n'
          
          # Gh√©p v·ªõi n·ªôi dung chi ti·∫øt
          FINAL_MSG="${TOTAL_MSG}${MESSAGE_DETAILS}"

          echo "G·ª≠i b√°o c√°o v·ªÅ Telegram..."
          send_telegram "$FINAL_MSG"
