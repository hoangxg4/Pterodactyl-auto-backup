name: Panel Auto Backup

on:
  schedule:
    # cháº¡y má»—i 12 tiáº¿ng
    - cron: "0 */12 * * *"
  workflow_dispatch: {}

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      PANEL_URL: ${{ secrets.PANEL_URL }}
      API_KEY: ${{ secrets.PANEL_API_KEY }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      MAX_BACKUPS: ${{ secrets.MAX_BACKUPS }}

    steps:
      - name: Run backup via curl
        run: |
          set -euo pipefail

          if [ -z "${MAX_BACKUPS:-}" ]; then MAX_BACKUPS=10; fi

          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null

          send_telegram() {
            local msg="$1"
            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${msg}" \
              -d "parse_mode=Markdown" >/dev/null || true
          }

          api_request() {
            local method="$1"
            local url="$2"
            shift 2 || true
            curl -sS -X "$method" "$url" \
              -H "Authorization: Bearer ${API_KEY}" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -H "User-Agent: DBH" \
              -H "X-Requested-With: XMLHttpRequest" \
              -H "Cache-Control: no-cache" \
              -H "Pragma: no-cache" \
              "$@"
          }

          PANEL_URL="${PANEL_URL%/}"

          echo "Láº¥y danh sÃ¡ch server..."
          servers_json=$(api_request GET "${PANEL_URL}/api/client")

          for row in $(echo "$servers_json" | jq -r '.data[] | @base64'); do
            _jq() { echo "$row" | base64 --decode | jq -r "$1"; }

            server_id=$(_jq '.attributes.identifier')
            server_name=$(_jq '.attributes.name')

            backups_json=$(api_request GET "${PANEL_URL}/api/client/servers/${server_id}/backups")
            backup_count=$(echo "$backups_json" | jq '.data | length')

            # XÃ“A BACKUP CÅ¨
            if [ "$backup_count" -ge "$MAX_BACKUPS" ]; then
              oldest=$(echo "$backups_json" | jq -r '.data | sort_by(.attributes.created_at) | .[0]')
              oldest_name=$(echo "$oldest" | jq -r '.attributes.name')
              oldest_uuid=$(echo "$oldest" | jq -r '.attributes.uuid')

              api_request DELETE "${PANEL_URL}/api/client/servers/${server_id}/backups/${oldest_uuid}" >/dev/null

              send_telegram \
"ğŸ—‘ï¸ ÄÃ£ xÃ³a backup cÅ© nháº¥t cá»§a server *${server_name}*
ğŸ“¦ TÃªn: ${oldest_name}"
            fi

            # Táº O BACKUP Má»šI
            backup_name="Auto Backup $(date '+%H-%M_%d-%m-%Y')"
            body=$(jq -n --arg name "$backup_name" '{name: $name}')

            new_backup=$(api_request POST "${PANEL_URL}/api/client/servers/${server_id}/backups" --data "$body")
            created_name=$(echo "$new_backup" | jq -r '.attributes.name')

            send_telegram \
"âœ… Backup thÃ nh cÃ´ng server *${server_name}*
ğŸ“¦ TÃªn: ${created_name}"
          done
