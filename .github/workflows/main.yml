name: Panel Auto Backup

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch: {}

# ‚ö†Ô∏è QUAN TR·ªåNG: C·∫•p quy·ªÅn ghi ƒë·ªÉ Action c√≥ th·ªÉ push file v√†o repo
permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      PANEL_URL: ${{ secrets.PANEL_URL }}
      API_KEY: ${{ secrets.PANEL_API_KEY }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      MAX_BACKUPS: ${{ secrets.MAX_BACKUPS }}

    steps:
      # 1. Ph·∫£i c√≥ b∆∞·ªõc n√†y ƒë·ªÉ t·∫£i code v·ªÅ th√¨ m·ªõi s·ª≠a file v√† push l·∫°i ƒë∆∞·ª£c
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run backup & Update Status
        run: |
          set -euo pipefail

          # --- KI·ªÇM TRA M√îI TR∆Ø·ªúNG ---
          if [ -z "${PANEL_URL:-}" ] || [ -z "${API_KEY:-}" ] || [ -z "${TELEGRAM_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "‚ùå Thi·∫øu env: PANEL_URL / API_KEY / TELEGRAM_TOKEN / TELEGRAM_CHAT_ID"
            exit 1
          fi

          if [ -z "${MAX_BACKUPS:-}" ]; then MAX_BACKUPS=10; fi

          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null

          # --- H√ÄM G·ª¨I TELEGRAM ---
          send_telegram() {
            local text="$1"
            curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${text}" \
              -d "parse_mode=HTML" >/dev/null || true
          }

          api_request() {
            local method="$1"
            local url="$2"
            shift 2 || true
            curl -sS -X "$method" "$url" \
              -H "Authorization: Bearer ${API_KEY}" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -H "User-Agent: DBH" \
              "$@"
          }

          PANEL_URL="${PANEL_URL%/}"

          # --- B·∫ÆT ƒê·∫¶U X·ª¨ L√ù ---
          echo "üîç L·∫•y danh s√°ch server..."
          servers_json=$(api_request GET "${PANEL_URL}/api/client") || exit 1

          SUCCESS_COUNT=0
          FAIL_COUNT=0
          MESSAGE_DETAILS=""
          
          # Bi·∫øn l∆∞u n·ªôi dung cho file log
          FILE_CONTENT="Last Update: $(date '+%H:%M %d/%m/%Y') (UTC)\n\n"

          for row in $(echo "$servers_json" | jq -r '.data[] | @base64'); do
            _jq() { echo "$row" | base64 --decode | jq -r "$1"; }

            server_id=$(_jq '.attributes.identifier')
            server_name=$(_jq '.attributes.name')
            server_log=""

            echo "‚ñ∂ X·ª≠ l√Ω server: ${server_name}"

            # 1. L·∫•y danh s√°ch backup
            backups_json=$(api_request GET "${PANEL_URL}/api/client/servers/${server_id}/backups") || {
              FAIL_COUNT=$((FAIL_COUNT+1))
              MESSAGE_DETAILS="${MESSAGE_DETAILS}‚ùå <b>${server_name}</b>: L·ªói l·∫•y danh s√°ch"$'\n'
              FILE_CONTENT="${FILE_CONTENT}[FAIL] ${server_name}: L·ªói API\n"
              continue
            }

            # 2. X√≥a backup c≈©
            backup_count=$(echo "$backups_json" | jq '.data | length')
            if [ "$backup_count" -ge "$MAX_BACKUPS" ]; then
              oldest=$(echo "$backups_json" | jq -r '.data | sort_by(.attributes.created_at) | .[0]')
              oldest_uuid=$(echo "$oldest" | jq -r '.attributes.uuid')
              oldest_name=$(echo "$oldest" | jq -r '.attributes.name')

              api_request DELETE "${PANEL_URL}/api/client/servers/${server_id}/backups/${oldest_uuid}" >/dev/null && \
              server_log="${server_log}üóëÔ∏è ƒê√£ x√≥a: ${oldest_name}"$'\n'
            fi

            # 3. T·∫°o backup m·ªõi
            backup_name="Auto Backup $(date '+%H-%M_%d-%m-%Y')"
            body=$(jq -n --arg name "$backup_name" '{name: $name}')

            new_backup=$(api_request POST "${PANEL_URL}/api/client/servers/${server_id}/backups" --data "$body") 
            
            if [ $? -eq 0 ]; then
              created_name=$(echo "$new_backup" | jq -r '.attributes.name')
              SUCCESS_COUNT=$((SUCCESS_COUNT+1))
              MESSAGE_DETAILS="${MESSAGE_DETAILS}‚úÖ <b>${server_name}</b>"$'\n'"${server_log}üì¶ T√™n: ${created_name}"$'\n\n'
              FILE_CONTENT="${FILE_CONTENT}[OK] ${server_name} -> ${created_name}\n"
            else
              FAIL_COUNT=$((FAIL_COUNT+1))
              MESSAGE_DETAILS="${MESSAGE_DETAILS}‚ùå <b>${server_name}</b>: Backup th·∫•t b·∫°i"$'\n\n'
              FILE_CONTENT="${FILE_CONTENT}[FAIL] ${server_name}: T·∫°o backup th·∫•t b·∫°i\n"
            fi
          done

          # --- G·ª¨I TELEGRAM ---
          TOTAL_MSG="üìä <b>B√ÅO C√ÅO AUTO BACKUP</b>"$'\n'
          TOTAL_MSG="${TOTAL_MSG}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"$'\n'
          TOTAL_MSG="${TOTAL_MSG}‚úÖ Th√†nh c√¥ng: <b>${SUCCESS_COUNT}</b>"$'\n'
          TOTAL_MSG="${TOTAL_MSG}‚ùå Th·∫•t b·∫°i: <b>${FAIL_COUNT}</b>"$'\n'
          TOTAL_MSG="${TOTAL_MSG}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"$'\n\n'
          
          FINAL_MSG="${TOTAL_MSG}${MESSAGE_DETAILS}"
          send_telegram "$FINAL_MSG"

          # --- T·∫†O FILE V√Ä PUSH GIT ---
          echo "üìù ƒêang c·∫≠p nh·∫≠t tr·∫°ng th√°i v√†o repo..."
          
          # Ghi n·ªôi dung v√†o file status.txt
          echo -e "${FILE_CONTENT}" > status.txt
          echo "-----------------------------------" >> status.txt
          echo "Total Success: ${SUCCESS_COUNT}" >> status.txt
          echo "Total Fail: ${FAIL_COUNT}" >> status.txt

          # C·∫•u h√¨nh Git (Bot Identity)
          git config --global user.name "Auto Backup Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Add, Commit v√† Push
          git add status.txt
          
          # Ch·ªâ commit n·∫øu c√≥ thay ƒë·ªïi (tr√°nh l·ªói n·∫øu file y h·ªát c≈© - d√π c√≥ timestamp th√¨ hi·∫øm khi tr√πng)
          if git diff --staged --quiet; then
            echo "Kh√¥ng c√≥ thay ƒë·ªïi ƒë·ªÉ commit."
          else
            git commit -m "Update backup status: $(date '+%d/%m/%Y')"
            git push
            echo "‚úÖ ƒê√£ push file status.txt th√†nh c√¥ng!"
          fi
